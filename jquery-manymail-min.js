
(function($){var _Sequence=1;$.fn.manyMail=function(settings){settings=$.extend({separator:";",title:"Submit your e-mail",modal:true,width:570,height:550,showHelp:true,showClient:true,showReset:true,validate:function(email){return defaultValidator(email);},loadAddresses:function(email){},decode:function(emailAddress){return emailAddress;},confirmation:function(email){return true;},send:function(email){alert("override settings.send method to send the e-mail \n(you would be sending to ["+email.To+"])");return;}},settings);this.each(function(){var alink=jQuery(this);var email=buildDefaultObject();email.settings=settings;email.startingEmail=email;getDataFromLink(email,alink);if(email.settings.loadAddresses){email.settings.loadAddresses(email);buildEmailLists(email);}
var mailHtml=buildDialogHtml(email);$("body").append(mailHtml);$(".mtp-button-delete").click(function(){$(this).parent().fadeOut();});alink.click(function(){buildEmailLists(email);wireUpDragNDrop(email);showDialog(email);return false;});});function showDialog(email){var dlgButtons={};if(email.settings.showHelp)dlgButtons["Help"]=function(){showHelpDialog();};if(email.settings.showClient)dlgButtons["Outlook"]=function(){getDataFromDialog(email);openInClientApp(email);}
if(email.settings.showReset)dlgButtons["Reset"]=function(){resetDialog(email.startingEmail);}
dlgButtons["Send"]=function(){getDataFromDialog(email);var errMsg=email.settings.validate(email);if(errMsg&&errMsg.length>0){showError(email,errMsg);}else{if(email.settings.confirmation(email)){email.settings.send(email);$(this).dialog("close");}}};$("#"+email.ID).dialog({modal:email.settings.modal,width:email.settings.width,height:email.settings.height,title:email.settings.title,buttons:dlgButtons})};function wireUpDragNDrop(email){var prefix="#"+email.ID;var sortableIDs="#"+email.ToListID+", #"+email.CcListID+", #"+email.BccListID;$(sortableIDs).sortable().disableSelection();var $tabs=$("#"+email.TabsID).tabs();var $tabItems=$("ul li",$tabs).droppable({accept:".connectedSortable li",hoverClass:"ui-state-hover",drop:function(event,ui){var $item=$(this);var $list=$($item.find("a").attr("href")).find(".connectedSortable");if($list.length>0){ui.draggable.hide("fast",function(){$tabs.tabs("select",$tabItems.index($item));$(this).appendTo($list).show("fast");});}}});};function showHelpDialog(){if($("#mtp-dlg-help").length==0){var helpHtml=buildHelpDialog();$("body").append(helpHtml);}
$("#mtp-dlg-help").dialog({modal:false,width:450,height:450,title:"Help",buttons:{Ok:function(){$(this).dialog("close");}}});};function buildHelpDialog(){var html="";html+='<div id="mtp-dlg-help" class="mtp-dlg ui-helper-hidden" title="manyMail help">';html+='<p>To send your e-mail, simply:</p>';html+='<ul>';html+='<li>Enter a relevant subject and message for your e-mail.</li>';html+='<li>Check all the people you want to send the e-mail to are in the <strong>To:</strong>, <strong>Cc:</strong> and/or <strong>Bcc:</strong> tabs.</li>';html+='<li>If you want someone in the <strong>To:</strong> tab recieve a blind-copy, simply drag \'n\' drop their address onto the <strong>Bcc:</strong> tab</li>';html+='<li>If you don\'t want someone to get the e-mail, simply click the little cross at the side of their address.</li>';html+='<li>If you make a mistake, simply click the <strong>Reset</strong> button to go back to where you started.</li>';html+='<li>When you\'re happy, click <strong>Send</strong>.</li>';html+='<li>If you prefer to use your installed e-mail applicatiion, click Outlook (you may not have Outlook, but you get the idea).</li>';html+='</ul>';html+='</div>';return html;};function openInClientApp(email){var href="mailto:"+email.To+"?";if(email.Cc)
href+="cc="+email.Cc;if(email.Bcc){if(!isLast(href,"?"))
href+="&";href+="bcc="+email.Bcc;}
if(email.Subject){if(!isLast(href,"?"))
href+="&";href+="subject="+email.Subject;}
if(email.Body){if(!isLast(href,"?"))
href+="&";href+="body="+email.Body;}
var winMail=window.open(href,"_blank","scrollbars=yes,resizable=yes,width=10,height=10");if(winMail)
winMail.close();};function isLast(inputString,isChar){if(inputString.length==0)
return false;if(inputString.charAt(inputString.length-1)==isChar)
return true;else
return false;};function resetDialog(email){$("#"+email.ID).find("#"+email.SubjectID).val(email.startingEmail.Subject).end().find("#"+email.BodyID).val(email.startingEmail.Body).end().find("#"+email.ToListID).children().remove().end().append(buildEmailButtonList(email.startingEmail.ToList)).end().find("#"+email.CcListID).children().remove().end().append(buildEmailButtonList(email.startingEmail.CcList)).end().find("#"+email.BccListID).children().remove().end().append(buildEmailButtonList(email.startingEmail.BccList));$(".mtp-button-delete",$("#"+email.TabsID)).click(function(){$(this).parent().fadeOut();});wireUpDragNDrop(email.startingEmail);};function showError(email,errMsg){var errDlg=$("#"+email.ErrDlgID);if(errDlg.length==0){var html="";html+='<div id="'+email.ErrDlgID+'" title="Error" class="ui-helper-hidden mtp-err-dlg">';html+='<div id="'+email.ErrMsgID+'">';html+=errMsg;html+='</div>';html+='</div>';$("body").append(html);errDlg=$("#"+email.ErrDlgID);}else{$("#"+email.ErrMsgID,errDlg).replaceWith(errMsg);}
errDlg.dialog({modal:true,buttons:{Ok:function(){$(this).dialog("close");}}});};function defaultValidator(email){if(email==null)
throw"defaultValidator expected an email object";var errMsg="";if(email.To==null||email.To=="")
errMsg+="<li>You need at least a <strong>To:</strong> address.</li>";if(email.Subject==null||email.Subject=="")
errMsg+="<li>You need to fill in the <strong>subject</strong> line.</li>";if(email.Body==null||email.Body=="")
errMsg+="<li>You need to fill in the <strong>body</strong>.</li>";if(errMsg!=""){errMsg='<p>Sorry, but we couldn\'t send the e-mail:</p>'+'<ul>'+errMsg+'</ul>';return errMsg;}
return"";};function getDataFromDialog(email){email.Subject=$.trim($("#"+email.SubjectID).val());email.Body=$.trim($("#"+email.BodyID).val());email.To="";email.ToList=[];email.Cc="";email.CcList=[];email.Bcc="";email.BccList=[];$("#"+email.ToListID+" li, #"+email.CcListID+" li, #"+email.BccListID+" li").each(function(index){var self=$(this);if(self.css("display")=="none")
return;var distId=self.parent().attr("id");var recipient=$.trim(self.text());var recipientSep=recipient+settings.separator;if(distId===email.ToListID)
email.ToList.push(recipient);else if(distId===email.CcListID)
email.CcList.push(recipient);else
email.BccList.push(recipient);});email.To=email.ToList.join(email.settings.separator);email.Cc=email.CcList.join(email.settings.separator);email.Bcc=email.BccList.join(email.settings.separator);return email;};function buildDefaultObject(){var rootID="mtp-"+_Sequence.toString();var emailObj={ID:rootID,From:"",Reply:"",To:"",Cc:"",Bcc:"",Subject:"",Body:"",ID:rootID,TabsID:rootID+"-tabs",ToListID:rootID+"-to-list",CcListID:rootID+"-cc-list",BccListID:rootID+"-bcc-list",FromID:rootID+"-from",ReplyID:rootID+"-reply",ToID:rootID+"-to",CcID:rootID+"-cc",BccID:rootID+"-bcc",SubjectID:rootID+"-subject",BodyID:rootID+"-body",ErrMsgID:rootID+"-err-msg",ErrDlgID:rootID+"-err-dlg"};_Sequence++;return emailObj;};function getDataFromLink(email,alink){if(alink==null)
return;if(alink.attr("tagName").toUpperCase()!="A")
return;if(alink.attr("href")==null)
return;var href=alink.attr("href");href=href.replace("?","&").replace("mailto:","?to=");var rootID="mtp-"+_Sequence.toString();email.From=email.settings.decode(getParameterByName(href,"from"));email.Reply=email.settings.decode(getParameterByName(href,"reply"));email.To=email.settings.decode(getParameterByName(href,"to"));email.Cc=email.settings.decode(getParameterByName(href,"cc"));email.Bcc=email.settings.decode(getParameterByName(href,"bcc"));email.Subject=getParameterByName(href,"subject");email.Body=getParameterByName(href,"body");buildEmailLists(email);return email;};function buildEmailLists(email){email.ToList=splitEmail(email.To,email.settings.separator);email.CcList=splitEmail(email.Cc,email.settings.separator);email.BccList=splitEmail(email.Bcc,email.settings.separator);};function splitEmail(emailList,sep){var arrEmails=emailList.split(sep);while(arrEmails.length>0&&arrEmails[arrEmails.length-1]==""){arrEmails.pop();}
return arrEmails;}
function buildDialogHtml(email){var html="";html+='<div id="'+email.ID+'" class="mtp-dlg ui-helper-hidden" title="'+email.settings.title+'">';html+='<ol class="mtp-header">';html+='<li>';html+='<label for="'+email.SubjectID+'" class="mtp-dlg-label">Subject:</label>';html+='<input type="text" id="'+email.SubjectID+'" class="ui-corner-all mtp-dlg-text" value="'+email.Subject+'" />';html+='</li>';html+='<li>';html+='<label for="'+email.BodyID+'" class="mtp-dlg-label">Message:</label>';html+='<textarea id="'+email.BodyID+'" class="ui-corner-all mtp-dlg-text mtp-dlg-body">'+email.Body+'</textarea>';html+='</li>';html+='</ol>';html+='<div id="'+email.TabsID+'" class="mtp-tabs">';html+='<ul>';html+='<li class="mtp-tab-item"><a href="#'+email.ToID+'">To:</a></li>';html+='<li class="mtp-tab-item"><a href="#'+email.CcID+'">Cc:</a></li>';html+='<li class="mtp-tab-item"><a href="#'+email.BccID+'">Bcc:</a></li>';html+='</ul>';html+='<div id="'+email.ToID+'">';html+='<ul id="'+email.ToListID+'" class="ui-helper-reset connectedSortable">';html+=buildEmailButtonList(email.ToList);html+='</ul>';html+='</div>';html+='<div id="'+email.CcID+'">';html+='<ul id="'+email.CcListID+'" class="ui-helper-reset connectedSortable">';html+=buildEmailButtonList(email.CcList);html+='</ul>';html+='</div>';html+='<div id="'+email.BccID+'">';html+='<ul id="'+email.BccListID+'" class="ui-helper-reset connectedSortable">';html+=buildEmailButtonList(email.BccList);html+='</ul>';html+='</div>';html+='</div>';html+='</div>';return html;};function buildEmailButtonList(emailList){var html="";for(var em in emailList){html+=buildEmailButton(emailList[em]);}
return html;};function buildEmailButton(emailAddress){var html='<li class="ui-state-default ui-corner-all mtp-button">'+
emailAddress+'<span class="ui-icon ui-icon-circle-close mtp-button-delete"></span>'+'</li>';return html;}
function getParameterByName(href,name){name=name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");var regexS="[\\?&]"+name+"=([^&#]*)";var regex=new RegExp(regexS);var results=regex.exec(href);if(results==null)
return"";else
return decodeURIComponent(results[1].replace(/\+/g," "));};};})(jQuery);